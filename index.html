<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Optimizador de imágenes</title>

<style>
:root{
    --bg:#f2f5f9;
    --text:#3c3c3c;
    --title:#3c3c3c;
    --card:#ffffff;
    --border:#e5e5e5;
    --accent:#48CAFF;
    --error:#ff4d4f;
}

*{box-sizing:border-box}

body{
    margin:0;
    padding:32px;
    font-family: "Montserrat", sans-serif;
    font-optical-sizing: auto;
    font-style: normal;
    background:var(--bg);
    color:var(--text);
    text-align:center;
    display: flex;
    flex-direction: column;
    align-items: center;
}

#card {
    background: white;
    border-radius: 10px;
    border: #d8d8d8 solid 1px;
    height: auto;
    width: 410px;
    padding: 30px;
    display:flex;
    flex-direction: column;
    gap: 20px;
}

#card .title {
    padding-bottom: 20px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    width:100%;
}

h1{
    margin: 0px 0px 4px;
    font-size: 24px;
    color:var(--title)
}

.size p {
    color: #6c6c6c;
    font-size: 13px;
}

.size {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

p{
    margin:0 0 4px 0;
    font-size:14px;
    text-align: left;
}

.config {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}

#controls{
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    width: 100%;
    gap:20px;
    justify-content: space-between;
    height: 100%;
    border-bottom: 1px solid var(--border);
}

#controls input[type=number]{
    padding:10px;
    border-radius:10px;
    border:1px solid var(--border);
    font-size:16px;
    text-align:center;
    width:100%;
    outline:none;
}

#controls input[type=number]:focus{
    border-color: var(--accent);
}

#controls input.error{
    border-color: var(--error);
}

#controls input::placeholder{
    opacity: 0.2;
    color: #000;
}

#optimgCheckboxContainer{
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

#optimgCheckbox{
    width: 18px;
    height: 18px;
    border: 2px solid var(--border);
    border-radius: 4px;
    display: inline-block;
    position: relative;
    transition: all 0.2s;
}

#optimgCheckbox.checked{
    border-color: var(--accent);
    background: var(--accent);
}

#optimgCheckbox.checked::after{
    content: "";
    position: absolute;
    left: 4px;
    top: 0px;
    width: 5px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

#optimgLabel{
    font-size: 14px;
    user-select: none;
    color: var(--text);
}

#optimgCheckbox.disabled{
    pointer-events: none;
    opacity: 0.5;
}

#dropzone{
    max-width: 540px;
    width: 350px;
    height: 250px;
    padding: 48px 20px;
    border: 2px dashed var(--border);
    border-radius: 10px;
    cursor: pointer;
    background: #fff;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 4px;
    color: var(--accent);
    transition: opacity 0.4s;
}

#dropzone.active{
    background:rgba(72,202,255,.08);
}

input[type=file]{
    display:none;
}

#preview{
    display:grid;
    grid-template-columns:repeat(auto-fill,220px);
    gap:26px;
    justify-content:center;
    margin-top:40px;
    max-width: 90%;
}

.preview-item{
    background:var(--card);
    border-radius:20px;
    box-shadow:0 10px 24px rgba(0,0,0,.08);
    border:1px solid var(--border);
}

.preview-frame{
    width:100%;
    aspect-ratio:1/1;
    background:#fff;
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
}

.preview-frame img{
    width:100%;
    height:100%;
    object-fit:contain;
}

#actions{
    display: flex;
    justify-content: flex-start;
    flex-direction: row;
    align-items: center;
    gap: 10px;
}

button{
    border:none;
    background:var(--accent);
    color:white;
    cursor:pointer;
    padding: 9px;
    border-radius: 30px;
    font-size: 14px;
    width:110px;
    display: none;
}
button.secondary{
    background:none;
    color:var(--accent);
    border:1px solid var(--accent);
}
</style>
</head>

<body>

<div id="card">
    <div class="config">
        <div class="title">
            <h1>Optimizador de imágenes</h1>
            <p>Aspect ratio fijo de 1:1 · Tamaño configurable</p>
        </div>

        <div id="controls">
            <div class="size">
                <p>Tamaño final (px):</p>
                <input id="sizeInput" type="number" min="50" max="5000" placeholder="Ej. 200px">

                <div id="optimgCheckboxContainer">
                    <div id="optimgCheckbox"></div>
                    <label id="optimgLabel">Añadir -optimg al nombre</label>
                </div>
            </div>

            <div id="actions">
                <button id="downloadBtn" onclick="downloadAll()">Descargar</button>
                <button id="clearBtn" class="secondary" onclick="resetAll()">Limpiar</button>
            </div>
        </div>
    </div>

    <div id="dropzone">
        <strong>Carga archivos</strong>
        o arrastra y suelta aquí
    </div>

    <input id="fileInput" type="file" multiple accept="image/*">
</div>

<div id="preview"></div>

<script>
const dz = document.getElementById("dropzone");
const fi = document.getElementById("fileInput");
const pv = document.getElementById("preview");
const downloadBtn = document.getElementById("downloadBtn");
const clearBtn = document.getElementById("clearBtn");
const sizeInput = document.getElementById("sizeInput");
const controls = document.getElementById("controls");

const optimgCheckbox = document.getElementById("optimgCheckbox");
let optimgChecked = false;

function updateCheckboxState(){
    if(sizeInput.disabled){
        optimgCheckbox.classList.add("disabled");
    } else {
        optimgCheckbox.classList.remove("disabled");
    }
}

optimgCheckbox.addEventListener("click", () => {
    if(sizeInput.disabled) return;
    optimgChecked = !optimgChecked;
    if(optimgChecked) optimgCheckbox.classList.add("checked");
    else optimgCheckbox.classList.remove("checked");
});

let results = [];

function isValidSize(){
    const val = parseInt(sizeInput.value);
    return val >= 50 && val <= 5000;
}

function updateDropzoneOpacity(){
    dz.style.opacity = sizeInput.value === "" ? 0.4 : 1;
}

function showSizeError(msg = "Primero debes introducir la medida final de las imágenes."){
    alert(msg);
    sizeInput.classList.add("error");
}

sizeInput.addEventListener("focus", () => sizeInput.classList.remove("error"));

// Prevenir cambio de tamaño si ya hay contenido
sizeInput.addEventListener("input", () => {
    if(results.length > 0){
        showSizeError("Primero debes limpiar las imágenes generadas antes de cambiar el tamaño.");
        sizeInput.value = "";
    }
    updateDropzoneOpacity();
});

function updateSizeInputState(){
    sizeInput.disabled = results.length > 0;
    updateCheckboxState();
}

updateDropzoneOpacity();
updateSizeInputState();

dz.onclick = () => {
    if(!isValidSize()) return showSizeError();
    fi.click();
};

dz.ondragover = e => {
    e.preventDefault();
    if(isValidSize()) dz.classList.add("active");
};

dz.ondragleave = () => dz.classList.remove("active");

dz.ondrop = e => {
    e.preventDefault();
    dz.classList.remove("active");
    if(!isValidSize()) return showSizeError();
    processFiles(e.dataTransfer.files);
};

fi.onchange = () => processFiles(fi.files);

function isBackground(r,g,b,a){
    if(a < 10) return true;
    const t = 255 * 0.05;
    return r > 255-t && g > 255-t && b > 255-t;
}

async function loadImage(file){
    return new Promise((resolve, reject) => {
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = () => {
            URL.revokeObjectURL(url);
            resolve(img);
        };
        img.onerror = reject;
        img.src = url;
    });
}

async function canvasToBlob(canvas){
    return new Promise(resolve => {
        canvas.toBlob(b => {
            if(b) resolve(b);
            else{
                const dataURL = canvas.toDataURL("image/jpeg", 0.95);
                const arr = dataURL.split(",");
                const mime = arr[0].match(/:(.*?);/)[1];
                const bin = atob(arr[1]);
                const u8 = new Uint8Array(bin.length);
                for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
                resolve(new Blob([u8],{type:mime}));
            }
        }, "image/jpeg", 0.95);
    });
}

async function processFiles(files){
    if(!isValidSize()) return;

    const outputSize = parseInt(sizeInput.value);
    updateSizeInputState(); // deshabilitar mientras haya contenido

    for(const file of files){
        const img = await loadImage(file);

        const c = document.createElement("canvas");
        c.width = img.width;
        c.height = img.height;
        const ctx = c.getContext("2d", { willReadFrequently:true });
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";
        ctx.drawImage(img,0,0);

        const d = ctx.getImageData(0,0,c.width,c.height).data;
        let top=0,bottom=c.height-1,left=0,right=c.width-1;

        const row=y=>{
            for(let x=0;x<c.width;x++){
                const i=(y*c.width+x)*4;
                if(!isBackground(d[i],d[i+1],d[i+2],d[i+3])) return true;
            }
            return false;
        };
        const col=x=>{
            for(let y=0;y<c.height;y++){
                const i=(y*c.width+x)*4;
                if(!isBackground(d[i],d[i+1],d[i+2],d[i+3])) return true;
            }
            return false;
        };

        while(top<bottom&&!row(top))top++;
        while(bottom>top&&!row(bottom))bottom--;
        while(left<right&&!col(left))left++;
        while(right>left&&!col(right))right--;

        const w = right - left + 1;
        const h = bottom - top + 1;
        const size = Math.max(w,h);
        const cx = left + w/2 - size/2;
        const cy = top + h/2 - size/2;

        const out = document.createElement("canvas");
        out.width = outputSize;
        out.height = outputSize;
        const o = out.getContext("2d");
        o.imageSmoothingEnabled = true;
        o.imageSmoothingQuality = "high";
        o.fillStyle = "#fff";
        o.fillRect(0,0,outputSize,outputSize);
        o.drawImage(c,cx,cy,size,size,0,0,outputSize,outputSize);

        const blob = await canvasToBlob(out);
        const previewUrl = URL.createObjectURL(blob);

        results.push({ blob, previewUrl, name: file.name });

        const div = document.createElement("div");
        div.className = "preview-item";
        div.innerHTML = `<div class="preview-frame"><img src="${previewUrl}"></div>`;
        pv.appendChild(div);
    }

    if(results.length){
        dz.style.display = "none";
        downloadBtn.style.display = "inline-block";
        clearBtn.style.display = "inline-block";
        controls.style.borderBottom = "none";
        updateSizeInputState();
    }
}

function downloadAll(){
    results.forEach(r=>{
        let dotIndex = r.name.lastIndexOf(".");
        let base = dotIndex !== -1 ? r.name.slice(0,dotIndex) : r.name;
        let ext = dotIndex !== -1 ? r.name.slice(dotIndex) : ".jpg";
        const a = document.createElement("a");
        a.href = r.previewUrl;
        a.download = optimgChecked ? `${base}-optimg${ext}` : `${base}${ext}`;
        a.click();
    });
}

function resetAll(clearPreview=true){
    results.forEach(r=>URL.revokeObjectURL(r.previewUrl));
    results=[];
    if(clearPreview) pv.innerHTML="";
    dz.style.display="flex";
    downloadBtn.style.display = "none";
    clearBtn.style.display = "none";
    controls.style.borderBottom="1px solid var(--border)";
    updateDropzoneOpacity();
    updateSizeInputState();
    fi.value = ""; 
}
</script>
</body>
</html>
